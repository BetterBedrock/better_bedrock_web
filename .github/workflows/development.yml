name: CI/CD Development Deploy

on:
  push:
    branches:
      - development

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      deployments: write

    steps:
      - name: Create GitHub Deployment
        uses: chrnorm/deployment-action@v2
        id: deployment
        with:
          token: ${{ github.token }}
          environment: development
          ref: ${{ github.sha }}

      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 300s
          script_stop: true
          script: |
            set -e
            echo "ğŸš€ Starting deployment..."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 22 || nvm use default
            echo "Using node version: $(node -v)"
            cd ${{ secrets.DEV_APP_DIR }}
            echo "ğŸ“¦ Pulling latest code..."
            git pull origin development
            echo "ğŸ“‹ Installing dependencies..."
            npx yarn install --frozen-lockfile
            echo "ğŸ—„ï¸ Running database operations..."
            cd apps/api
            npx yarn prisma generate
            npx yarn prisma migrate deploy
            echo "ğŸ“ Running Linters & Steiger..."
            npx yarn steiger
            cd ${{ secrets.DEV_APP_DIR }}
            echo "ğŸ”„ Stopping services..."
            pm2 stop better-bedrock-web-dev || true
            pm2 stop better-bedrock-api-dev || true
            pm2 delete better-bedrock-web-dev || true
            pm2 delete better-bedrock-api-dev || true
            echo "ğŸ”¨ Building application..."
            npx yarn build
            echo "ğŸ”„ Starting services..."
            pm2 start ecosystem.config.js --only "better-bedrock-web-dev,better-bedrock-api-dev"
            pm2 save
            pm2 startup -u $USER --hp $HOME
            echo "âœ… Deployment completed successfully!"
            echo "ğŸ“Š PM2 Status:"
            pm2 status

      - name: Update Deployment Status (Success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          state: success
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          environment_url: https://dev.betterbedrock.com/

      - name: Update Deployment Status (Failure)
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          state: failure
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
